<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<sub-flow name="get-staff-details" doc:id="b6f3b91e-f203-44b3-b9b0-61a677a0a223" >
		<set-variable value="#[if (attributes.uriParams.'p' != null) attributes.uriParams.'p' as Number else 1]" doc:name="Set Page" doc:id="0baed40c-1910-4c37-98c2-2a7b834e54b4" variableName="page"/>
		<set-variable value="#[if (attributes.uriParams.'ps' !=null) attributes.uriParams.'ps' as Number else 50]" doc:name="Set PageSize" doc:id="531fa42b-246b-4dc5-98c4-ffd2deea0e3f" variableName="pageSize"/>
		<db:select doc:name="Select all Staff" doc:id="7055436c-568d-4450-910e-827174a17d50" config-ref="Database_Config" >
			<db:sql ><![CDATA[SELECT FirstName,LastName,Email, Role, Active
FROM staff
WHERE id > :min AND id <= :max
ORDER BY id]]></db:sql>
			<db:input-parameters ><![CDATA[#[{ 
	min: (vars.page - 1) * vars.pageSize,
	max: vars.page * vars.pageSize
	
}]]]></db:input-parameters>
		</db:select>
		<logger level="INFO" doc:name="Logger" doc:id="e76da201-2efd-42cb-82cb-e91826125057" message="#[payload]"/>
	</sub-flow>
	<sub-flow name="get-staff-detail-with-id" doc:id="de630db2-b664-442a-9a47-d7ff66c7210d" >
		<db:select doc:name="Get a Specific Staff Details" doc:id="7716f6b7-b0a8-4dfe-a455-24c4e200929a" config-ref="Database_Config" >
			<db:sql ><![CDATA[SELECT FirstName,LastName,Email, Role, Active
FROM staff
WHERE id = :id]]></db:sql>
			<db:input-parameters ><![CDATA[#[{
	id: attributes.uriParams.'staffId'
}]]]></db:input-parameters>
		</db:select>
		<logger level="INFO" doc:name="Logger" doc:id="f6c3f9c0-855b-454e-9ecb-5884b5c952c5" message="#[payload]"/>
	</sub-flow>
	<!-- [STUDIO:"create-staff"]<sub-flow name="create-staff" doc:id="dcf85f72-edf3-4283-b08d-7ddd87bbbc63" /> [STUDIO] -->
	<sub-flow name="update-staff-details-with-id" doc:id="6bd461b4-3aa2-41cb-9fbe-bb3df1437122" >
		<set-variable value='#[%dw 2.0 &#10;output application/java&#10;---&#10;"UPDATE staff \n"&#10;++ &#10;"SET \n"&#10;++&#10;(keysOf(&#10;    payload filterObject ((value, key, index) -&gt; (value != null and value != ""))&#10;    ) &#10; map ( $ ++ " = :" ++ $)&#10; joinBy  " , \n")&#10;&#10; ++ "\n"&#10; ++ "WHERE id = :id"&#10;&#10;//"UPDATE staff SET role = :role, active = :active WHERE id = :id"]' doc:name="SQL Query" doc:id="5bd7816f-7b9e-43b9-b207-f24dd8945d36" variableName="query" />
		<set-variable value="#[%dw 2.0 &#10;output application/java&#10;---&#10;payload ++ {&#10;	&quot;id&quot; : attributes.uriParams.'staffId'&#10;}&#10;&#10;//{&#10;//  role : &quot;Manager&quot;,&#10;//  active: true,&#10;//  id : 1&#10;//}]" doc:name="Query Data" doc:id="5957847b-9d06-4e88-8633-ccadca2572c9" variableName="queryData" />
		<db:update doc:name="Update Staff Details" doc:id="ba9fbcb8-9074-42f2-a47b-6b832d2a148d" config-ref="Database_Config">
			<db:sql ><![CDATA[#[vars.query]]]></db:sql>
			<db:input-parameters ><![CDATA[#[vars.queryData]]]></db:input-parameters>
		</db:update>
	</sub-flow>
	<sub-flow name="delete-staff-details-with-id" doc:id="1dc0069f-dc11-4bf5-a00a-9eb033b9625e" >
		<db:select doc:name="Delete Staff" doc:id="110ced37-bba4-4cbe-a19c-de57e098eb98" config-ref="Database_Config">
			<db:sql><![CDATA[UPDATE staff
SET active = false
WHERE id = :id]]></db:sql>
			<db:input-parameters><![CDATA[#[{
	id: attributes.uriParams.'staffId'
}]]]></db:input-parameters>
		</db:select>
	</sub-flow>
</mule>
